# 一、取消预约
## 1、需求描述

**取消订单分两种情况：**

（1）未支付取消订单，直接通知医院更新取消预约状态

（2）已支付取消订单，先退款给用户，然后通知医院更新取消预约状态

## 2、开发取消预约接口
参考文档：https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9\_4

该接口需要使用证书，详情参考文档并下载证书  

### （1）配置证书
请下载的证书放在service-order模块/resources/cert文件夹下

在application.properties文件配置证书路径  

```bash
weixin.cert= 
C:\\yygh_parent\\service\\service_order\\src\\main\\resources\\cert\\apiclient_cert.p12
```
###  （2）添加获取支付记录方法
操作PaymentService接口和实现类

```java
/**
     * 获取支付记录
     * @param orderId
     * @param paymentType
     * @return
     */
PaymentInfo getPaymentInfo(Long orderId, Integer paymentType);

//实现获取支付记录方法
@Override
public PaymentInfo getPaymentInfo(Long orderId, Integer paymentType) {
    QueryWrapper<PaymentInfo> queryWrapper = new QueryWrapper<>();
    queryWrapper.eq("order_id", orderId);
    queryWrapper.eq("payment_type", paymentType);
    return baseMapper.selectOne(queryWrapper);
}
```
### （3）添加退款记录
**添加RefundInfoMapper**

```java
public interface RefundInfoMapper extends BaseMapper<RefundInfo> {
}
```
**添加RefundInfoService方法和实现**  
```java
//RefundInfoService
public interface RefundInfoService extends IService<RefundInfo> {
    /**
     * 保存退款记录
     * @param paymentInfo
     */
    RefundInfo saveRefundInfo(PaymentInfo paymentInfo);
}

//RefundInfoServiceImpl
@Service
public class RefundInfoServiceImpl extends ServiceImpl<RefundInfoMapper, RefundInfo> implements RefundInfoService {

    @Override
    public RefundInfo saveRefundInfo(PaymentInfo paymentInfo) {
        QueryWrapper<RefundInfo> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("order_id", paymentInfo.getOrderId());
        queryWrapper.eq("payment_type", paymentInfo.getPaymentType());
        RefundInfo refundInfo = baseMapper.selectOne(queryWrapper);
        if(null != refundInfo) return refundInfo;
        // 保存交易记录
        refundInfo = new RefundInfo();
        refundInfo.setCreateTime(new Date());
        refundInfo.setOrderId(paymentInfo.getOrderId());
        refundInfo.setPaymentType(paymentInfo.getPaymentType());
        refundInfo.setOutTradeNo(paymentInfo.getOutTradeNo());
        refundInfo.setRefundStatus(RefundStatusEnum.UNREFUND.getStatus());
        refundInfo.setSubject(paymentInfo.getSubject());
        //paymentInfo.setSubject("test");
        refundInfo.setTotalAmount(paymentInfo.getTotalAmount());
        baseMapper.insert(refundInfo);
        return refundInfo;
    }
}
```
### （4）添加微信退款方法
**在WeixinService添加方法**  

```java
    /***
     * 退款
     * @param orderId
     * @return
     */
    Boolean refund(Long orderId);
```
**在WeixinServiceImpl添加实现**  

```java
@Override
public Boolean refund(Long orderId) {
    try {
        PaymentInfo paymentInfoQuery = paymentService.getPaymentInfo(orderId, PaymentTypeEnum.WEIXIN.getStatus());

        RefundInfo refundInfo = refundInfoService.saveRefundInfo(paymentInfoQuery);
        if(refundInfo.getRefundStatus().intValue() == RefundStatusEnum.REFUND.getStatus().intValue()) {
            return true;
        }
        Map<String,String> paramMap = new HashMap<>(8);
        paramMap.put("appid",ConstantPropertiesUtils.APPID);       //公众账号ID
        paramMap.put("mch_id",ConstantPropertiesUtils.PARTNER);   //商户编号
        paramMap.put("nonce_str",WXPayUtil.generateNonceStr());
        paramMap.put("transaction_id",paymentInfoQuery.getTradeNo()); //微信订单号
        paramMap.put("out_trade_no",paymentInfoQuery.getOutTradeNo()); //商户订单编号
        paramMap.put("out_refund_no","tk"+paymentInfoQuery.getOutTradeNo()); //商户退款单号
        //       paramMap.put("total_fee",paymentInfoQuery.getTotalAmount().multiply(new BigDecimal("100")).longValue()+"");
        //       paramMap.put("refund_fee",paymentInfoQuery.getTotalAmount().multiply(new BigDecimal("100")).longValue()+"");
        paramMap.put("total_fee","1");
        paramMap.put("refund_fee","1");
        String paramXml = WXPayUtil.generateSignedXml(paramMap,ConstantPropertiesUtils.PARTNERKEY);
        HttpClient client = new HttpClient("https://api.mch.weixin.qq.com/secapi/pay/refund");
        client.setXmlParam(paramXml);
        client.setHttps(true);
        client.setCert(true);
        client.setCertPassword(ConstantPropertiesUtils.PARTNER);
        client.post();
        //3、返回第三方的数据
        String xml = client.getContent();
        Map<String, String> resultMap = WXPayUtil.xmlToMap(xml);
        if (null != resultMap && WXPayConstants.SUCCESS.equalsIgnoreCase(resultMap.get("result_code"))) {
            refundInfo.setCallbackTime(new Date());
            refundInfo.setTradeNo(resultMap.get("refund_id"));
            refundInfo.setRefundStatus(RefundStatusEnum.REFUND.getStatus());
            refundInfo.setCallbackContent(JSONObject.toJSONString(resultMap));
            refundInfoService.updateById(refundInfo);
            return true;
        }
        return false;
    }  catch (Exception e) {
        e.printStackTrace();
    }
    return false;
}
```
###  （5）完成取消预约方法
**在OrderService添加和实现**  

```java
/**
     * 取消订单
     * @param orderId
     */
Boolean cancelOrder(Long orderId);

//实现方法
@Override
public Boolean cancelOrder(Long orderId) {
    OrderInfo orderInfo = this.getById(orderId);
    //当前时间大约退号时间，不能取消预约
    DateTime quitTime = new DateTime(orderInfo.getQuitTime());
    if(quitTime.isBeforeNow()) {
        throw new YyghException();
    }

    Map<String, Object> reqMap = new HashMap<>();
    reqMap.put("hoscode",orderInfo.getHoscode());
    reqMap.put("hosRecordId",orderInfo.getHosRecordId());
    reqMap.put("timestamp", HttpRequestHelper.getTimestamp());
    reqMap.put("sign", "");

    JSONObject result = HttpRequestHelper.sendRequest(reqMap, "http://localhost:9998/order/updateCancelStatus");

    if(result.getInteger("code") != 200) {
        throw new YyghException(ResultCodeEnum.FAIL.getCode(),result.getString("message"));
    } else {
        //是否支付 退款
        if(orderInfo.getOrderStatus().intValue() == OrderStatusEnum.PAID.getStatus().intValue()) {
            //已支付 退款
            boolean isRefund = weixinService.refund(orderId);
            if(!isRefund) {
                throw new YyghException();
            }
        }
        //更改订单状态
        orderInfo.setOrderStatus(OrderStatusEnum.CANCLE.getStatus());
        this.updateById(orderInfo);
        //更新支付记录状态。
        QueryWrapper<PaymentInfo> queryWrapper=new QueryWrapper<PaymentInfo>();
        queryWrapper.eq("order_id",orderId);

        PaymentInfo paymentInfo = paymentInfoService.getOne(queryWrapper);
        paymentInfo.setPaymentStatus(-1); //退款
        paymentInfo.setUpdateTime(new Date());
        paymentInfoService.updateById(paymentInfo);

        //发送mq信息更新预约数 我们与下单成功更新预约数使用相同的mq信息，不设置可预约数与剩余预约数，接收端可预约数减1即可
        OrderMqVo orderMqVo = new OrderMqVo();
        orderMqVo.setScheduleId(orderInfo.getScheduleId());
        //短信提示
        MsmVo msmVo = new MsmVo();
        msmVo.setPhone(orderInfo.getPatientPhone());
        orderMqVo.setMsmVo(msmVo);
        rabbitService.sendMessage(MqConst.EXCHANGE_DIRECT_ORDER, MqConst.ROUTING_ORDER, orderMqVo);
    }
    return true;
}
```
### （6）在WeixinService添加方法
在OrderInfoController添加方法
```java
@ApiOperation(value = "取消预约")
@GetMapping("auth/cancelOrder/{orderId}")
public R cancelOrder(
    @ApiParam(name = "orderId", value = "订单id", required = true)
    @PathVariable("orderId") Long orderId) {

    Boolean flag = orderInfoService.cancelOrder(orderId);
    return R.ok().data("flag",flag);
}
```
### （7）修改监听器方法
修改HospitalReceiver 类

```java
@Component
public class HospitalReceiver {

    @Autowired
    private ScheduleService scheduleService;

    @Autowired
    private RabbitService rabbitService;

    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(value = MqConst.QUEUE_ORDER, durable = "true"),
            exchange = @Exchange(value = MqConst.EXCHANGE_DIRECT_ORDER),
            key = {MqConst.ROUTING_ORDER}
    ))
    public void receiver(OrderMqVo orderMqVo, Message message, Channel channel) {
        if(null != orderMqVo.getAvailableNumber()) {
            //更新排班
            Schedule schedule = scheduleService.getById(orderMqVo.getScheduleId());
            schedule.setReservedNumber(orderMqVo.getReservedNumber());
            schedule.setAvailableNumber(orderMqVo.getAvailableNumber());
            scheduleService.update(schedule);
        } else {
            //取消预约更新预约数
            Schedule schedule = scheduleService.getById(orderMqVo.getScheduleId());
            int availableNumber = schedule.getAvailableNumber().intValue() + 1;
            schedule.setAvailableNumber(availableNumber);
            scheduleService.update(schedule);
        }
        //发送短信
        MsmVo msmVo = orderMqVo.getMsmVo();
        if(msmVo != null) {
            rabbitService.sendMessage(MqConst.EXCHANGE_DIRECT_MSM, MqConst.ROUTING_MSM_ITEM, msmVo);
        }
    }
}
```
## 3、开发微信退款前端
### （1）添加wx.js添加方法

```javascript
cancelOrder(orderId) {
    return request({
        url: `/api/order/orderInfo/auth/cancelOrder/${orderId}`,
        method: 'get'
    })
},
```
### （2）修改show.vue组件
```javascript
//取消预约方法
cancelOrder() {
    this.$confirm('确定取消预约吗?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
    }).then(() => { // promise
        // 点击确定，远程调用
        return weixinApi.cancelOrder(this.orderId)
    }).then((response) => {
        this.$message.success('取消成功')
        this.init()
    })
}
```